---
title: "Week 11 workbook and solutions"
description: |
author:
  - name: Joseph Bulbulia
    url: https://josephbulbulia.netlify.app
    affiliation: Victoria University of Wellington
    affiliation_url: https://www.wgtn.ac.nz
    orcid_id: 0000-0002-5861-2056
output:
  distill::distill_article:
    self_contained: false
    toc: true
    highlight: kate
    code_folding: true
---

Import the jittered NZAVS dataset

```{r setup, include = FALSE}
# setup
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  layout = "l-body-outset",
  fig.width= 12,
  fig.height= 10,
  collapse =TRUE,
  R.options = list(width = 60)
)
```

```{r}
### Libraries
library("tidyverse")
library("patchwork")
library("lubridate")
library("kableExtra")
library("gtsummary")
library("lubridate")
library("equatiomatic")
library("ggdag")
library("brms")
library("rstan")
library("rstanarm")
library("bayesplot")
library("easystats")
library("kableExtra")
library("broom")
library("tidybayes")
library("bmlm")
# rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores ())
theme_set(theme_classic())
```

```{r  nzdata, include = TRUE}
# read data

nz_0 <- as.data.frame(readr::read_csv2(
  url(
    "https://raw.githubusercontent.com/go-bayes/psych-447/main/data/nzj.csv"
  )
))

# to re-level kessler 6 variables
f <-
  c(
    "None Of The Time",
    "A Little Of The Time",
    "Some Of The Time",
    "Most Of The Time",
    "All Of The Time"
  )

# get data into shape
nz_cr <- nz_0 %>%
  dplyr::mutate_if(is.character, factor) %>%
  dplyr::select(
    -c(
      SWB.Kessler01,
      SWB.Kessler02,
      SWB.Kessler03,
      SWB.Kessler04,
      SWB.Kessler05,
      SWB.Kessler06
    )
  ) %>% 
  dplyr::mutate(Wave = as.factor(Wave)) %>%
  dplyr::mutate(FeelHopeless = forcats::fct_relevel(FeelHopeless, f)) %>%
  dplyr::mutate(FeelDepressed = forcats::fct_relevel(FeelDepressed, f)) %>%
  dplyr::mutate(FeelRestless = forcats::fct_relevel(FeelRestless, f)) %>%
  dplyr::mutate(EverythingIsEffort = forcats::fct_relevel(EverythingIsEffort, f)) %>%
  dplyr::mutate(FeelWorthless = forcats::fct_relevel(FeelWorthless, f)) %>%
  dplyr::mutate(FeelNervous = forcats::fct_relevel(FeelNervous, f)) %>%
  dplyr::mutate(Wave = as.factor(Wave)) %>%
  dplyr::mutate(male_id = as.factor(Male)) %>%
  dplyr::mutate(date = make_date(year = 2009, month = 6, day = 30) + TSCORE) %>%
  dplyr::mutate(
    FeelWorthless_int = as.integer(FeelWorthless),
    FeelNervous_int =  as.integer(FeelNervous),
    FeelHopeless_int =  as.integer(FeelHopeless),
    EverythingIsEffort_int =  as.integer(EverythingIsEffort),
    FeelRestless_int =  as.integer(FeelRestless),
    FeelDepressed_int =  as.integer(FeelDepressed),
    HLTH.Fatigue_int = as.integer(HLTH.Fatigue + 1)
  ) %>%
  dplyr::mutate( yearS = (TSCORE - min(TSCORE)/365) ) %>%
  dplyr::mutate(KESSLER6sum = as.integer(KESSLER6sum))

## if you do anything with covid (warning, such a model would be tricky)

ord_dates_class <- c("Baseline",
                     "PreCOVID",
                     "JanFeb",
                     "EarlyMarch",
                     "Lockdown",
                     "PostLockdown")

nzl <- nz_cr %>%
  dplyr::filter(YearMeasured == 1) %>%
  dplyr::mutate(yearS = (TSCORE - min(TSCORE)/365)) %>%
  dplyr::mutate(WSCORE = as.factor(WSCORE)) %>%
  dplyr::mutate(Covid_Timeline =
                  as.factor(ifelse(
                    TSCORE %in% 3896:3921,
                    # feb 29 - march 25th
                    "EarlyMarch",
                    ifelse(
                      TSCORE %in% 3922:3954,
                      "Lockdown",
                      #march 26- Mon 27 April 2020
                      ifelse(
                        TSCORE > 3954,
                        # after april 27th 20202
                        "PostLockdown",
                        ifelse(
                          TSCORE %in% 3842:3895,
                          # jan 6 to feb 28
                          "JanFeb",
                          ifelse(TSCORE %in% 3665:3841 &
                                   Wave == 2019,
                                 "PreCOVID",
                                 "Baseline"  # 3672 TSCORE or  20 July 2019))))))))
                          )
                        )
                      )
                    ))))%>%
  dplyr::mutate(Covid_Timeline = forcats::fct_relevel(Covid_Timeline, ord_dates_class))%>%
  dplyr::mutate(Id = factor(Id))

```

```{r include = FALSE}
# inspect data
dplyr::glimpse(nzl)
```

## Assessment

1. What is the difference between prediction and causal inference: give an example for how regression is useful for each task. 

2. Explain "collider confounding" (or "collider bias"), and give an example of how collider bias might spoil inference.

3. Using the `nz` data, select at least five demongraphic/ideological variables that might be related to an exposure variable and outcome variable. Create a DAG and identify which variables we should condition on to obtain an unbiased estimate of the causal effect of the exposure variable on the outcome variable. 

4. Write a DAG for one of your previous workbook regression analyses; explain your DAG, and use it to clarify which variables you should conditioning on to obtain an unbiased causal inference (conditional on your DAG) . Compare the results of your current model with your previous model and note any differences. 

5. Explain `masking` relationships and using the methods in lecture and/or the readings, simulate data and interpret the results of a regression model in which you causally assess the effect of X on Y in a setting where X also affects Y through and effect on Z. 

6.  Import this dataset: 

According to a psychological theory that one of you is working on, "prototypicality of M훮ori group membership moderates the effect of perceived discrimination on ethnic identity in M훮ori."

Using at least the following three variables are from *Wave 4* from the dataset address the causal claims in this theory, noting ways in which the theory might be improved up.  Make sure to include a DAG and make sure to clarify the DAGs assumptions (no need to draw on previous psychological theories.)

-   T4.MAORI.GME (M훮ori Group membership and evaluation)

-   T4.MAORI.VEM (M훮ori Perceived Appearance)

-   Perc.Discrim.T04 (Perceived discrimination - ethnicity)

    -   I Feel that I am often discriminated against because of my ethnicity.
    -   I feel that I am often discriminated against because of my ethnicity.


### Additional information: 

Link to the NZAVS data dictionary is [here](https://dl.dropboxusercontent.com/s/but0pz9h4jdpy6f/NZAVS-Technical-Documents-e02-Data-Dictionary.xlsx?dl=0)

Link to questions only [here](https://dl.dropboxusercontent.com/s/cv256sbjal4ucvo/nzavs-data-dictionary.htm?dl=0)


## Marking criteria

1.  Clarity and organisation in the descriptive component of your work.

2.  Clarity and organisation in description of your regression model.

3.  Accuracy and insight in the interpretation of your regression model.

### Reports I've been doing FYI

<https://go-bayes.github.io/reports/>
