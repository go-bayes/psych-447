---
title: "Week 10 workbook and solutions"
description: |
author:
  - name: Joseph Bulbulia
    url: https://josephbulbulia.netlify.app
    affiliation: Victoria University of Wellington
    affiliation_url: https://www.wgtn.ac.nz
    orcid_id: 0000-0002-5861-2056
output:
  distill::distill_article:
    self_contained: false
    toc: true
    highlight: kate
    code_folding: true
---

Import the jittered NZAVS dataset

```{r setup, include = FALSE}
# setup
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  layout = "l-body-outset",
  fig.width= 12,
  fig.height= 10,
  collapse =TRUE,
  R.options = list(width = 60)
)
```

```{r}
### Libraries
library("tidyverse")
library("patchwork")
library("lubridate")
library("kableExtra")
library("gtsummary")
library("lubridate")
library("equatiomatic")
library("ggdag")
library("brms")
library("rstan")
library("rstanarm")
library("bayesplot")
library("easystats")
library("kableExtra")
library("broom")
library("tidybayes")
library("bmlm")
# rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores ())
theme_set(theme_classic())
```

```{r  nzdata, include = TRUE}
# read data

nz_0 <- as.data.frame(readr::read_csv2(
  url(
    "https://raw.githubusercontent.com/go-bayes/psych-447/main/data/nzj.csv"
  )
))

# to re-level kessler 6 variables
f <-
  c(
    "None Of The Time",
    "A Little Of The Time",
    "Some Of The Time",
    "Most Of The Time",
    "All Of The Time"
  )

# get data into shape
nz_cr <- nz_0 %>%
  dplyr::mutate_if(is.character, factor) %>%
  dplyr::select(
    -c(
      SWB.Kessler01,
      SWB.Kessler02,
      SWB.Kessler03,
      SWB.Kessler04,
      SWB.Kessler05,
      SWB.Kessler06
    )
  ) %>% 
  dplyr::mutate(Wave = as.factor(Wave)) %>%
  dplyr::mutate(FeelHopeless = forcats::fct_relevel(FeelHopeless, f)) %>%
  dplyr::mutate(FeelDepressed = forcats::fct_relevel(FeelDepressed, f)) %>%
  dplyr::mutate(FeelRestless = forcats::fct_relevel(FeelRestless, f)) %>%
  dplyr::mutate(EverythingIsEffort = forcats::fct_relevel(EverythingIsEffort, f)) %>%
  dplyr::mutate(FeelWorthless = forcats::fct_relevel(FeelWorthless, f)) %>%
  dplyr::mutate(FeelNervous = forcats::fct_relevel(FeelNervous, f)) %>%
  dplyr::mutate(Wave = as.factor(Wave)) %>%
  dplyr::mutate(male_id = as.factor(Male)) %>%
  dplyr::mutate(date = make_date(year = 2009, month = 6, day = 30) + TSCORE) %>%
  dplyr::mutate(
    FeelWorthless_int = as.integer(FeelWorthless),
    FeelNervous_int =  as.integer(FeelNervous),
    FeelHopeless_int =  as.integer(FeelHopeless),
    EverythingIsEffort_int =  as.integer(EverythingIsEffort),
    FeelRestless_int =  as.integer(FeelRestless),
    FeelDepressed_int =  as.integer(FeelDepressed),
    HLTH.Fatigue_int = as.integer(HLTH.Fatigue + 1)
  ) %>%
  dplyr::mutate( yearS = (TSCORE - min(TSCORE)/365) ) %>%
  dplyr::mutate(KESSLER6sum = as.integer(KESSLER6sum))

## if you do anything with covid (warning, such a model would be tricky)

ord_dates_class <- c("Baseline",
                     "PreCOVID",
                     "JanFeb",
                     "EarlyMarch",
                     "Lockdown",
                     "PostLockdown")

nzl <- nz_cr %>%
  dplyr::filter(YearMeasured == 1) %>%
  dplyr::mutate(yearS = (TSCORE - min(TSCORE)/365)) %>%
  dplyr::mutate(WSCORE = as.factor(WSCORE)) %>%
  dplyr::mutate(Covid_Timeline =
                  as.factor(ifelse(
                    TSCORE %in% 3896:3921,
                    # feb 29 - march 25th
                    "EarlyMarch",
                    ifelse(
                      TSCORE %in% 3922:3954,
                      "Lockdown",
                      #march 26- Mon 27 April 2020
                      ifelse(
                        TSCORE > 3954,
                        # after april 27th 20202
                        "PostLockdown",
                        ifelse(
                          TSCORE %in% 3842:3895,
                          # jan 6 to feb 28
                          "JanFeb",
                          ifelse(TSCORE %in% 3665:3841 &
                                   Wave == 2019,
                                 "PreCOVID",
                                 "Baseline"  # 3672 TSCORE or  20 July 2019))))))))
                          )
                        )
                      )
                    ))))%>%
  dplyr::mutate(Covid_Timeline = forcats::fct_relevel(Covid_Timeline, ord_dates_class))%>%
  dplyr::mutate(Id = factor(Id))

```

```{r include = FALSE}
# inspect data
#dplyr::glimpse(nzl)
```

## Assessment

### Information

Link to the NZAVS data dictionary is [here](https://dl.dropboxusercontent.com/s/but0pz9h4jdpy6f/NZAVS-Technical-Documents-e02-Data-Dictionary.xlsx?dl=0)

Link to questions only [here](https://dl.dropboxusercontent.com/s/cv256sbjal4ucvo/nzavs-data-dictionary.htm?dl=0)

## Create a distill website

1.  Create a distill website [see](https://rstudio.github.io/distill/website.html)

2.  Create a postcard for yourself [see](<https://alison.rbind.io/post/2020-12-22-postcards-distill/>

3.  Set up your distill webpage with your postcard on github: [see]((https://rstudio.github.io/distill/website.html#creating-a-website))

4.  Publish your postcard

Note you do not need to publish a personal website if you don't wish to do so. We can assess you on the basis of a publishable website. Please see us for help.

## Create a distill report

1.  Using the `nzl` dataset or another dataset of your choice, write a varying intercept/varying slope model.

Note the `nzl` dataset now includes 2845 individuals who have responded to at least five waves of the NZAVS. The dataset now includes relationship satisfaction `Your.Personal.Relationships` and employment security `Emp.JobSecure`

```{r}
# center religion
nzl1 <- nzl %>%
  dplyr::mutate( Relid_c = scale(Relid, scale = FALSE))%>%
  dplyr::mutate(CharityDonate = as.integer(CharityDonate))%>%
  dplyr::mutate(CharityDonate_log = log(CharityDonate + 1))

str(nzl1)

# demean
nzl1 <- cbind(nzl1, 
           parameters::demean(nzl1, 
                  c("Relid"),
                  group = "Id")
           )

nzl1 <- nzl1 %>%
  dplyr::mutate(Relid_between_c = scale(Relid_between, center = TRUE, scale = FALSE))  
# test dataset
m1 <- brms::brm(CharityDonate ~ yearS + Relid_c  + (1 + Relid_c|Id),  
                family = "negbinomial",
                file = here::here("models", "workbook_10_ex1"),
                data = nzl1)

summary(m1)
```

Note poor mixing. This is a sign of a problem:

```{r cache=TRUE, eval=FALSE}
# results
parameters::model_parameters(
  m1,
  dispersion = FALSE,
  test = "pd",
  priors = TRUE,
  effects = "all"
)%>% print_md()
```

```{r cache=TRUE}
# graph
p_m1 <- plot(brms::conditional_effects(m1,
                            "Relid_c",
                            spaghetti = TRUE,
                            nsamples = 100)
             )[[1]]
p_m1
```

## Attempt model with demeaned data



```{r}
m2 <-
  brms::brm(
    CharityDonate ~ yearS + Relid_within + Relid_between_c  + 
      (1 + Relid_within | Id),
    family = "negbinomial",
    file = here::here("models", "workbook_10_ex2"),
    data = nzl1
  )
```

We can see that people are rounding in their estimates:

```{r}
summary(m2, prior = TRUE)
brms::pp_check(m2) + scale_x_continuous(limits = c(0,10000))
```

```{r cache=TRUE}
# graph
p_m2a <- plot(brms::conditional_effects(m2,
                            c("Relid_within"),
                            spaghetti = TRUE,
                            re_formula = NULL,
                            nsamples = 100)
             )
p_m2a
```
```{r}
p_m2b <- plot(brms::conditional_effects(m2,
                            c("Relid_between_c"),
                            spaghetti = TRUE,
                            re_formula = NULL, # all group-level effects
                            nsamples = 100)
             )
p_m2b
```
# Log transform outcomes


```{r eval=FALSE}
# Response distributions in brms
#https://cran.r-project.org/web/packages/brms/vignettes/brms_families.html

# What is this? 
hist(nzl1$CharityDonate_log)

m3 <-
  brms::brm(
    CharityDonate_log ~  yearS + Relid_within + Relid_between_c  +
      (1 + Relid_within | Id),
    family = "hurdle_lognormal",
    file = here::here("models", "workbook_10_ex3"),
    data = nzl1
  )
```


```

## Marking criteria

1.  Clarity and organisation in the descriptive component of your work.

2.  Clarity and organisation in description of your regression model.

3.  Accuracy and insight in the interpretation of your regression model.

### Reports I've been doing FYI

<https://go-bayes.github.io/reports/>
